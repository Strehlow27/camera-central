---
import "../styles/global.css";
import SiteHeader from "../components/SiteHeader.astro";
import { ClientRouter } from "astro:transitions";
import Analytics from "@vercel/analytics/astro";

const {
  title = "Camera Central",
  description = "Find the right camera fast. Personalized picks and side-by-side compare.",

  // ✅ Put an actual file at /public/cameracentralLOGO.png (recommended: 1200x630)
  ogImage = "/cameracentralLOGO.png",

  // Optional: set these later if you make a Twitter/X account
  twitterSite = "",    // e.g. "@cameracentral"
  twitterCreator = "", // e.g. "@benstrehlow"

  tight = false,
} = Astro.props;

const origin = (Astro.site ?? Astro.url.origin);
const canonicalUrl = new URL(Astro.url.pathname, origin).toString();
const ogImageUrl = new URL(ogImage, origin).toString();
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>

    <!-- ✅ Canonical -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- ✅ Basic SEO -->
    <meta name="description" content={description} />
    <meta name="robots" content="index,follow" />
    <meta name="theme-color" content="#ffffff" />

    <!-- ✅ OpenGraph -->
    <meta property="og:site_name" content="Camera Central" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <!-- ✅ Twitter cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />
    {twitterSite && <meta name="twitter:site" content={twitterSite} />}
    {twitterCreator && <meta name="twitter:creator" content={twitterCreator} />}

    <!-- ✅ Favicon(s) -->
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <!-- <link rel="icon" href="/favicon.svg" type="image/svg+xml" /> -->

    <!-- ✅ Enables smooth page transitions -->
    <ClientRouter />

    <!-- ✅ Global click tracking (available on every page) -->
    <script is:inline>
      (function () {
        const KEY = "cc_event_queue";
        const MAX = 300;

        function safeJsonParse(s, fallback) {
          try { return JSON.parse(s); } catch { return fallback; }
        }

        function enqueue(evt) {
          try {
            const arr = safeJsonParse(localStorage.getItem(KEY) || "[]", []);
            arr.push(evt);
            while (arr.length > MAX) arr.shift();
            localStorage.setItem(KEY, JSON.stringify(arr));
          } catch {}
        }

        function trySend(evt) {
          // Disabled for MVP (no backend endpoint yet)
          return;
        }

        window.ccTrack = function (name, props) {
          const evt = {
            name: String(name || "event"),
            props: props && typeof props === "object" ? props : {},
            path: window.location.pathname,
            url: window.location.href,
            ref: document.referrer || "",
            ts: Date.now(),
          };

          enqueue(evt);

          // Dev-only logging
          try {
            if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
              console.log("[ccTrack]", evt.name, evt.props);
            }
          } catch {}

          // Future-proof hooks (only if added later)
          try {
            if (typeof window.plausible === "function") {
              window.plausible(evt.name, { props: evt.props });
            }
          } catch {}

          try {
            if (typeof window.gtag === "function") {
              window.gtag("event", evt.name, evt.props);
            }
          } catch {}

          try {
            if (Array.isArray(window.dataLayer)) {
              window.dataLayer.push({ event: evt.name, ...evt.props });
            }
          } catch {}

          trySend(evt);
        };
      })();
    </script>
  </head>

  <body class="bg-white text-gray-900 antialiased">
    <SiteHeader transition:persist />

    <main class="min-h-screen bg-gradient-to-b from-gray-50 to-white">
      <div class={`max-w-5xl mx-auto px-6 ${tight ? "py-6" : "py-12"}`}>
        <slot />
      </div>
    </main>

    <!-- ✅ Global compare badge sync (works across transitions) -->
    <script is:inline>
      (function () {
        const KEY = "cc_compare";

        function safeLoadIds() {
          try {
            const arr = JSON.parse(localStorage.getItem(KEY) || "[]");
            return Array.isArray(arr) ? arr.filter(Boolean) : [];
          } catch {
            return [];
          }
        }

        function unique(list) {
          const seen = new Set();
          return (list || []).filter((x) => {
            const k = String(x || "");
            if (!k || seen.has(k)) return false;
            seen.add(k);
            return true;
          });
        }

        function setBadge(count) {
          const badge = document.getElementById("ccCompareBadge");
          if (!badge) return;

          if (!count) {
            badge.textContent = "";
            badge.classList.add("hidden");
            return;
          }

          badge.textContent = String(count);
          badge.classList.remove("hidden");
        }

        function syncFromStorage() {
          const ids = unique(safeLoadIds());
          setBadge(ids.length);
        }

        syncFromStorage();

        window.addEventListener("cc-compare-updated", (e) => {
          const ids = e?.detail?.ids;
          if (Array.isArray(ids)) setBadge(unique(ids).length);
          else syncFromStorage();
        });

        window.addEventListener("storage", (e) => {
          if (e.key === KEY) syncFromStorage();
        });

        document.addEventListener("astro:after-swap", syncFromStorage);
        document.addEventListener("astro:page-load", syncFromStorage);
      })();
    </script>

    <!-- ✅ Vercel Analytics (put near end of body) -->
    <Analytics />
  </body>
</html>