---
import "../styles/global.css";
import SiteHeader from "../components/SiteHeader.astro";
import { ClientRouter } from "astro:transitions";
import Analytics from "@vercel/analytics/astro";

const {
  title = "Camera Central Yes!",
  description = "Find the right camera fast. Personalized picks and side-by-side compare.",

  // ✅ Put an actual file at /public/cameracentralLOGO.png (recommended: 1200x630)
  ogImage = "/cameracentralLOGO.png",

  // Optional: set these later if you make a Twitter/X account
  twitterSite = "",
  twitterCreator = "",

  tight = false,
} = Astro.props;

const origin = Astro.site ?? Astro.url.origin;
const canonicalUrl = new URL(Astro.url.pathname, origin).toString();
const ogImageUrl = new URL(ogImage, origin).toString();

// ✅ "Last updated" (from Vercel git metadata when available)
const vercelCommit = import.meta.env.VERCEL_GIT_COMMIT_TIMESTAMP;
const lastUpdatedISO = vercelCommit
  ? new Date(Number(vercelCommit) * 1000).toISOString()
  : null;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>

    <!-- ✅ Canonical -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- ✅ Basic SEO -->
    <meta name="description" content={description} />
    <meta name="robots" content="index,follow" />
    <meta name="theme-color" content="#ffffff" />

    <!-- ✅ OpenGraph -->
    <meta property="og:site_name" content="Camera Central" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <!-- ✅ Twitter cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />
    {twitterSite && <meta name="twitter:site" content={twitterSite} />}
    {twitterCreator && <meta name="twitter:creator" content={twitterCreator} />}

    <!-- ✅ Favicon(s) -->
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <!-- <link rel="icon" href="/favicon.svg" type="image/svg+xml" /> -->

    <!-- ✅ Fonts (kills the “generic SaaS / ChatGPT look”) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;9..144,700&family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- ✅ Enables smooth page transitions -->
    <ClientRouter />

    <!-- ✅ Global click tracking (available on every page) -->
    <script is:inline>
      (function () {
        const KEY = "cc_event_queue";
        const MAX = 300;

        function safeJsonParse(s, fallback) {
          try { return JSON.parse(s); } catch { return fallback; }
        }

        function enqueue(evt) {
          try {
            const arr = safeJsonParse(localStorage.getItem(KEY) || "[]", []);
            arr.push(evt);
            while (arr.length > MAX) arr.shift();
            localStorage.setItem(KEY, JSON.stringify(arr));
          } catch {}
        }

        function trySend(evt) {
          // Disabled for MVP (no backend endpoint yet)
          return;
        }

        // ✅ Single source of truth for app tracking
        window.ccTrack = function (name, props) {
          const evt = {
            name: String(name || "event"),
            props: props && typeof props === "object" ? props : {},
            path: window.location.pathname,
            url: window.location.href,
            ref: document.referrer || "",
            ts: Date.now(),
          };

          enqueue(evt);

          // Dev-only logging
          try {
            if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
              console.log("[ccTrack]", evt.name, evt.props);
            }
          } catch {}

          // Plausible support (if you add it later)
          try {
            if (typeof window.plausible === "function") {
              window.plausible(evt.name, { props: evt.props });
            }
          } catch {}

          // ✅ GA4 support (gtag)
          try {
            if (typeof window.gtag === "function") {
              window.gtag("event", evt.name, evt.props);
            }
          } catch {}

          // ✅ Tag Manager style (dataLayer)
          try {
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({ event: evt.name, ...evt.props });
          } catch {}

          trySend(evt);
        };
      })();
    </script>

    {import.meta.env.PUBLIC_GA4_ID && (
      <>
        <!-- ✅ Google tag (gtag.js) -->
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${import.meta.env.PUBLIC_GA4_ID}`}></script>

        <!-- ✅ Correct GA config using a real value injected by Astro -->
        <script is:inline data-ga-id={import.meta.env.PUBLIC_GA4_ID}>
          (function () {
            const id = document.currentScript?.getAttribute("data-ga-id");
            if (!id) return;
            try {
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              window.gtag = window.gtag || gtag;
              window.gtag("js", new Date());
              window.gtag("config", id, { anonymize_ip: true });
            } catch {}
          })();
        </script>
      </>
    )}

    <!-- ✅ Global style pass: fonts + background + subtle “brand” -->
    <style is:global>
      :root {
        --cc-font-body: "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        --cc-font-display: "Fraunces", ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;

        /* Brand accents (feel free to tweak later) */
        --cc-ink: #0b1220;      /* deep ink */
        --cc-muted: #4b5563;    /* gray-600-ish */
        --cc-accent: #0f2a1d;   /* deep evergreen */
      }

      html, body {
        font-family: var(--cc-font-body);
      }

      /* Headings get the display font */
      h1, h2, h3, .cc-display {
        font-family: var(--cc-font-display);
        letter-spacing: -0.01em;
      }

      /* Slightly nicer selection color (small touch, feels “designed”) */
      ::selection {
        background: rgba(15, 42, 29, 0.18);
      }

      /* Make links feel less “default” without breaking Tailwind */
      a {
        text-underline-offset: 3px;
      }

      /* A gentle “premium” hover on buttons */
      button, a[role="button"] {
        transition: transform 120ms ease, box-shadow 160ms ease, background-color 160ms ease, border-color 160ms ease, opacity 160ms ease;
      }
      button:active, a[role="button"]:active {
        transform: translateY(0.5px);
      }

      /* Background wrapper styling */
      .cc-page-bg {
        background:
          radial-gradient(900px 500px at 20% 0%, rgba(15, 42, 29, 0.10), transparent 60%),
          radial-gradient(700px 420px at 90% 10%, rgba(17, 24, 39, 0.08), transparent 55%),
          linear-gradient(to bottom, #f8fafc, #ffffff 55%);
      }

      /* Make cards feel a bit less “Tailwind demo” */
      .cc-card {
        border-color: rgba(17, 24, 39, 0.12) !important;
        box-shadow:
          0 1px 0 rgba(17, 24, 39, 0.04),
          0 10px 30px rgba(17, 24, 39, 0.06) !important;
      }
    </style>
  </head>

  <body class="bg-white text-gray-900 antialiased">
    <SiteHeader />

    <!-- ✅ New: original background wrapper -->
    <main class="min-h-screen cc-page-bg">
      <div class={`max-w-5xl mx-auto px-6 ${tight ? "py-6" : "py-12"}`}>
        <slot />
      </div>
    </main>

    <!-- ✅ Global compare badge sync (works across transitions) -->
    <script is:inline>
      (function () {
        const KEY = "cc_compare";

        function safeLoadIds() {
          try {
            const arr = JSON.parse(localStorage.getItem(KEY) || "[]");
            return Array.isArray(arr) ? arr.filter(Boolean) : [];
          } catch {
            return [];
          }
        }

        function unique(list) {
          const seen = new Set();
          return (list || []).filter((x) => {
            const k = String(x || "");
            if (!k || seen.has(k)) return false;
            seen.add(k);
            return true;
          });
        }

        function setBadge(count) {
          const badge = document.getElementById("ccCompareBadge");
          if (!badge) return;

          if (!count) {
            badge.textContent = "";
            badge.classList.add("hidden");
            return;
          }

          badge.textContent = String(count);
          badge.classList.remove("hidden");
        }

        function syncFromStorage() {
          const ids = unique(safeLoadIds());
          setBadge(ids.length);
        }

        syncFromStorage();

        window.addEventListener("cc-compare-updated", (e) => {
          const ids = e?.detail?.ids;
          if (Array.isArray(ids)) setBadge(unique(ids).length);
          else syncFromStorage();
        });

        window.addEventListener("storage", (e) => {
          if (e.key === KEY) syncFromStorage();
        });

        document.addEventListener("astro:after-swap", syncFromStorage);
        document.addEventListener("astro:page-load", syncFromStorage);
      })();
    </script>

    <!-- ✅ Vercel Analytics (put near end of body) -->
    <Analytics />
  </body>
</html>